function n(){this.H=!1;this.w=0}var p=new (window.AudioContext||window.webkitAudioContext);function q(){var a=r,b=sourceNode;a.aa=s;a.p=p.createAnalyser();a.p.smoothingTimeConstant=0.3;a.p.fftSize=2048;a.O=b;a.O.connect(a.p);t(a,512)}function t(a,b){a.k&&a.k.disconnect();a.k=p.createJavaScriptNode(b,1,1);a.k.onaudioprocess=function(){var b=a.aa,d=new Uint8Array(a.p.frequencyBinCount);a.p.getByteFrequencyData(d);a.O.playbackState==a.O.PLAYING_STATE&&b(d)};a.p.connect(a.k);a.H&&a.Play()}
function u(){var a=r;return a.o?a.w+(new Date-a.o)/1E3:a.w}n.prototype.Play=function(){this.k.connect(p.destination);this.H=!0;this.o||(this.o=new Date)};new chroma.ColorScale({colors:["#f00","#ff0","#0f0","#0ff","#00f"],mode:"rgb"});var v=new chroma.ColorScale({colors:"#f00 #f00 #ff0 #0f0 #0ff #00f #00f".split(" "),mode:"rgb"}),w=new chroma.ColorScale({colors:"#f08 #f00 #ff0 #0f0 #0ff #00f #80f".split(" "),mode:"rgb"});
function x(a,b,c){if(!c.a||c.a.length!=a.length){c.a=Array(parseInt(a.length));for(var d=0;d<c.a.length;d++)c.a[d]=0}for(d=0;d<c.a.length;d++)c.a[d]=a[d]<c.a[d]?c.a[d]+(a[d]-c.a[d])/5:c.a[d]+(a[d]-c.a[d])/200;for(d=0;d<a.length;d++){var e=a[d]-c.a[d]*b,e=256*e/(256-c.a[d]*b);a[d]=e}}
function y(a,b,c,d){for(var e=[],f=0;f<a.length;f++){var g=w.getColor(f/(a.length-1)).hsv();e.push({val:a[f],j:g[0]})}e.sort(function(a,b){return b.val-a.val});c.globalAlpha=1;c.globalCompositeOperation="source-over";c.fillStyle="#000";c.fillRect(0,0,1,b.height);a=0.5;for(var h=null,k=0,f=0;f<e.length;f++){var l=e[f];switch(d){case "HSL1":g=a;a+=1/e.length/2;c.fillStyle=chroma.hsl(l.j,1,g).hex();break;case "Opacity":c.fillStyle="hsla("+l.j+", 100%, 50%, 0.1)";break;case "HSV1":var m=1-f/e.length;
c.fillStyle=chroma.hsv(l.j,1,m).hex();break;case "HSV2":null==h&&(h=chroma.rgb(0,0,0));this_color=chroma.hsv(l.j,1,1);h=g=chroma.interpolate(h,this_color,1/(f+1),"rgb");c.fillStyle=g.hex();break;case "HSV3":m=l.val/256;null==h&&(h=chroma.rgb(0,0,0));this_color=chroma.hsv(l.j,1,m);h=g=chroma.interpolate(h,this_color,1/(f+1),"rgb");m/=e.length;g=g.hsv();g=chroma.hsv(g[0],g[1],k+m);k+=m;c.fillStyle=g.hex();break;case "HSV4":m=l.val/256,g=chroma.hsv(l.j,1,2.25*(m/e.length)),c.globalCompositeOperation=
"lighter",c.fillStyle=g.hex()}c.fillRect(0,(1-l.val/256)*b.height,1,b.height)}c.globalCompositeOperation="source-over"}function z(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push({val:a[e],j:v.getColor(e/(a.length-1)).hsv()[0]});d.sort(function(a,b){return b.val-a.val});c.globalAlpha=1;c.fillStyle="#000";c.fillRect(0,0,1,b.height);for(e=0;e<d.length;e++)a=d[e],this_color=chroma.hsv(a.j,1,a.val/256),c.fillStyle=this_color.hex(),c.fillRect(0,(1-a.val/256)*b.height,1,5)};function A(){this.c=[];this.B=[];B(this,"ColorDbl");this.v="HSV4";this.g=250;var a={g:300};a.mode&&B(this,a.mode);a.g&&(this.g=a.g);this.d=document.createElement("canvas");this.f=this.d.getContext("2d");this.d.width=1;this.h=document.createElement("canvas");this.C=this.h.getContext("2d");this.$=document.createElement("canvas");this.$.getContext("2d");this.hot=new chroma.ColorScale({colors:["#000000","#ffffff"],ba:[0,1],mode:"rgb",limits:[0,300]})}
function C(a,b){a.height!=b&&(a.height=b,console.log("set height "+b))}function B(a,b){a.mode=b;a.e=0;a.T=0;a.S=0;a.I=0;a.b=0.75;switch(b){case "SpectLog":a.n=150;a.m=12E3;break;case "LogStretch":a.n=150;a.m=12E3;a.e=13;break;case "HueValues":a.n=150;a.m=12E3;a.e=32;break;case "HueDots":a.n=150;a.m=12E3;a.e=7;break;case "ColorDbl":a.n=550,a.m=6E3,a.e=7,a.T=80,a.S=1100,a.I=100}}function D(a,b){E(b,a.n,a.m,a.e,a.c)}
function E(a,b,c,d,e){if(e.length!=d){for(e.splice(0,e.length);e.length<d;)e.push(0);console.log("LogBins: "+d+" ("+e.length+")")}logBinLength=e.length;Math.log(b);Math.log(c);var f,g,h,k;for(d=0;d<logBinLength;d++){f=Math.log(22050);g=Math.log(b)/f;h=Math.log(c)/f;k=g+d/logBinLength*(h-g);g+=(d+1)/logBinLength*(h-g);k=Math.pow(Math.E,k*f);g=Math.pow(Math.E,g*f);f=k*a.length/22050;k=g*a.length/22050;g=0;for(h=Math.floor(f);h<=Math.ceil(k);h++)g+=a[h];g/=Math.ceil(k)-Math.floor(f)+1;e[d]=g}}
function F(a,b,c){for(var d=c.length,e=0;e<d;e++)b.fillStyle=a.hot.getColor(c[e]).hex(),b.fillRect(0,d-1-e,1,1)};function G(){this.G=!1;this.R=1}function H(a,b){a.height!=b&&(a.height=b,console.log("set height "+b))}function I(){var a=new G;a.t("#canvas");return a}G.prototype.t=function(a){$canvas=$(a);this.canvas=$canvas[0];this.F=this.canvas.getContext("2d");J(this);this.U=32;this.L=2};
function J(a){var b=$(a.canvas),c=b.parent().height(),d=b.parent().width(),e=Math.round(b.parent().width()*a.R);if(a.canvas.width!=e||b.height()!=c){var f=document.createElement("canvas");f.width=a.canvas.width;f.height=a.canvas.height;f.getContext("2d").drawImage(canvas,0,0);a.canvas.width=e;a.F.drawImage(f,e-f.width,0);b.css("width",d+"px");b.css("height",c+"px");console.log("CanvasResize w:"+a.canvas.width+"->"+e+","+d+" h:"+a.canvas.height+"->"+c)}}
function K(a){var b=L,c=b.canvas.width,d=b.canvas.height;b.F.drawImage(b.canvas,-1*b.L,0,c,d);H(b.canvas,a.height);b.G&&!b.N?(J(b),b.N=setInterval(function(){J(b)},2E3)):!b.G&&b.N&&delete b.N;b.F.drawImage(a,c-b.U,0,b.U,d);b.M&&b.M(a)}function M(a,b){for(var c=a.toDataURL("image/png"),c=atob(c.substring(22)),d=new Uint8Array(c.length),e=0,f=c.length;e<f;++e)d[e]=c.charCodeAt(e);b(new Blob([d.buffer],{type:"image/png"}))};function N(){if($(".jsHeightToBottom").length){var a=$(window).height()-$(".jsHeightToBottom").offset().top;$(".jsHeightToBottom").height(a-3)}}
function O(){var a=$(".windowBtn_min"),b=$(".windowBtn_max"),c=$(".windowBtn_close");$(window).on("focus",function(){$("body").addClass("hasFocus")});$(window).on("blur",function(){$("body").removeClass("hasFocus")});if(chrome.app.window){var d=chrome.app.window.current();a.on("click",function(){d.minimize()});b.on("click",function(){d.isMaximized()?d.restore():d.maximize()});c.on("click",function(){d.close()})}setTimeout(N,50);$(window).on("resize",function(){N()})}
window.addEventListener("load",function(){O()});function P(){}function Q(a,b){void 0!=R()[b]&&$("."+a).val(R()[b]).change()}function S(a){var b=a.l,c=b.mode;""!=b.v&&(c+="/"+b.v);$(".csmAlg").val(c);$(".csmMoveByPx").val(a.canvas.L);$(".csmLog1Min").val(b.n);$(".csmLog1Max").val(b.m);$(".csmLogSteps").val(b.e);$(".csmDamper").val(b.b);$(".csmBufferSize").val(a.P.k?a.P.k.bufferSize:512);$(".csmXCompress").val(a.canvas.R)}
function T(a){$(".csmAlg").on("change",function(){var b=$(".csmAlg").val().split("/"),c=2==b.length?b[1]:"";B(a.l,b[0]);a.l.v=c;S(a)});$(".csmMoveByPx").on("change",function(){a.canvas.L=$(".csmMoveByPx").val()});$(".csmLog1Min").on("change",function(){a.l.n=$(".csmLog1Min").val()});$(".csmLog1Max").on("change",function(){a.l.m=$(".csmLog1Max").val()});$(".csmLogSteps").on("change",function(){a.l.e=$(".csmLogSteps").val()});$(".csmDamper").on("change",function(){a.l.b=$(".csmDamper").val()});$(".csmBufferSize").on("change",
function(){t(a.P,$(".csmBufferSize").val())});$(".csmXCompress").on("change",function(){a.canvas.R=$(".csmXCompress").val()})}
P.prototype.t=function(a,b,c){$optionsLink=$(".settingsToggler");$optionsDiv=$(".settingsDiv");0==$optionsDiv.length&&console.log("Error: settings.Init() called before html loaded!");this.l=b;this.canvas=c;this.P=a;T(this);S(this);Q("csmAlg","alg");Q("csmMoveByPx","moveByPx");Q("csmLog1Min","log1Min");Q("csmLog1Max","log1Max");Q("csmLogSteps","logSteps");Q("csmDamper","damper");Q("csmBufferSize","bufferSize");Q("csmXCompress","xCompress");$optionsLink.on("click",function(){$optionsDiv.slideToggle();
return!1});$(document).click(function(){$optionsDiv.slideUp()});$optionsDiv.click(function(a){a.stopPropagation()})};function U(){this.q=[];this.W=this.D=0}function V(a,b){console.log("Recording start, elapsed: "+u());a.D=0;a.q=[];a.A=b;a.A.M=function(b){var d=a.D%1E3;a.D++;if(0==d){console.log("cnvsAr ++");var e=document.createElement("canvas");e.width=1E3;e.height=b.height;a.q.push(e)}a.q[a.q.length-1].getContext("2d").drawImage(b,d,0,1,b.height)};a.W=u()}function W(){this.q=[]}
W.prototype.t=function(a){var b=this;this.A=a;$(".csmPngStartBtn").on("click",function(){b.r=new U;V(b.r,b.A);$(".csmPngStartBtn").hide();$(".csmPngDiv").slideDown()});$(".csmPngDiscardBtn").on("click",function(){var a=b.r;console.log("Recording stop,  elapsed: "+u());delete a.A.M;delete b.r;$(".csmPngDiv").slideUp();$(".csmPngStartBtn").show()});$(".csmPngSaveBtn").on("click",function(){aa(b)})};
function ba(a,b,c){var d=saveDlg.i;cnvsAr=a.q;lineCount=Math.ceil(d/c);a=document.createElement("canvas");a.width=Math.min(d,c);a.height=b*lineCount;for(var d=a.getContext("2d"),e=0;e<cnvsAr.length;e++)for(var f=1E3*e,g=Math.floor(f/c),f=f-g*c,g=g*b,h=Math.ceil((1E3-(c-f))/c),k=0;k<=h;k++)d.drawImage(cnvsAr[e],0,0,cnvsAr[e].width,cnvsAr[e].height,f-c*k,parseInt(g)+b*k,cnvsAr[e].width,b);return a}
function ca(a,b){var c="aurora_"+(saveDlg.u?saveDlg.u+"h":"")+saveDlg.J+"m"+saveDlg.V+"s.png";M(a,function(a){chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:c},function(c){c?c.createWriter(function(c){c.onwriteend=function(){console.log("Save complete!");b()};c.write(a)},function(a){console.log(a)}):(console.log("No writableFileEntry."),b())})})}
function X(){var a=saveDlg,b=a.document,c=$(".jsLineHeight",b).val(),d=$(".jsWrapAt",b).val(),e=$(".jsWrapUnits",b).val(),f=999;"px"==e?f=Math.round(d):"sec"==e?f=Math.round(d/a.s*a.i):"min"==e?f=Math.round(60*(d/a.s)*a.i):"nths"==e&&(f=Math.ceil(a.i/d));$(".jsLineWidth",b).val(f);$(".jsLinePxEach",b).html(f);d=Math.ceil(100*(a.i/f))/100;e=Math.min(f,a.i);c*=Math.ceil(d);$(".jsLineCount",b).html(d);$(".jsFinalPngX",b).html(e);$(".jsFinalPngY",b).html(c);$(".jsLineTimeEach",b).html(Math.round(Math.min(f,
a.i)/a.i*a.s,1));32767<e||32767<c?$(".jsDimLimitWarning",b).slideDown():$(".jsDimLimitWarning",b).slideUp()}
function aa(a){chrome.app.window.create("appPngSave.html",{bounds:{width:500,height:400},frame:"none"},function(b){saveDlg=b.contentWindow;saveDlg.i=a.r.D;saveDlg.s=u()-a.r.W;saveDlg.u=Math.floor(saveDlg.s/60/60);saveDlg.J=Math.floor(saveDlg.s/60)-60*saveDlg.u;saveDlg.V=Math.floor(saveDlg.s)-3600*saveDlg.u-60*saveDlg.J;saveDlg.addEventListener("load",function(){var c=saveDlg.document;$(".jsTotalPx",c).html(saveDlg.i);$(".jsDuration",c).html(saveDlg.u+"h "+saveDlg.J+"m "+saveDlg.V+"s");X();$(".jsRefreshDimsOnInput",
c).on("input",function(){X()});$(".jsRefreshDimsOnChange",c).on("change",function(){X()});$(".jsSavePngNow",c).on("click",function(){var d=$(".jsLineHeight",c).val(),e=$(".jsLineWidth",c).val(),d=ba(a.r,d,e);ca(d,function(){b.close()})});$(".jsCancelPngNow",c).on("click",function(){b.close()})})})};function R(){var a={};location.search.slice(1).split("&").forEach(function(b){b=b.split("=");a[b[0]]=b[1]||""});return a}function Y(a){console.log(a)}
function s(a){var b=Z;C(b.d,b.g);switch(b.mode){case "FullLin":C(b.h,a.length);F(b,b.C,a);b.f.drawImage(b.h,0,0,1,a.length,0,0,1,b.g);break;case "SpectLog":b.e=b.g;D(b,a);0<b.b&&x(b.c,b.b,b.d);F(b,b.f,b.c);break;case "LogStretch":C(b.h,b.e);D(b,a);0<b.b&&x(b.c,b.b,b.d);0<b.b&&x(b.c,b.b,b.d);a=b.c.length;for(var c=chroma.rgb(0,0,0),d=0;d<a;d++){var e=w.getColor(d/(a-1));b.C.fillStyle=chroma.interpolate(c,e,b.c[d]/256,"rgb").hex();b.C.fillRect(0,a-1-d,1,1)}b.f.drawImage(b.h,0,0,1,b.e,0,0,1,b.g);break;
case "HueValues":D(b,a);0<b.b&&x(b.c,b.b,b.d);y(b.c,b.d,b.f,b.v);break;case "HueDots":D(b,a);z(b.c,b.d,b.f);break;case "ColorDbl":D(b,a);0<b.b&&x(b.c,b.b,b.d);b.f.globalAlpha=1;y(b.c,b.d,b.f,b.v);C(b.h,b.I);E(a,b.T,b.S,b.I,b.B);x(b.B,0.9,b.h);a=b.h;c=b.C;d=b.B;c.globalAlpha=1;c.clearRect(0,0,1,d.length);for(var f=e=0;f<d.length;f++)e+=d[f]/256;e/=d.length;d=(1-e)*a.height;c.fillStyle="#222";e=c.createLinearGradient(0,d,0,d+a.height);e.addColorStop(0,"#222");e.addColorStop(1,"#000");c.fillStyle=e;
c.fillRect(0,d,1,a.height);a=2*(b.g/3);c=1*(b.g/3);b.f.globalCompositeOperation="lighter";b.f.drawImage(b.h,0,0,1,b.B.length,0,a,1,c);b.f.globalCompositeOperation="source-over"}K(b.d)}var r=new n,L,Z,da=new P,ea=new W;
window.addEventListener("load",function(){Z=new A;L=I();L.G=!0;$(".startBtn").on("click",function(){r.Play()});$(".stopBtn").on("click",function(){var a=r;a.k.disconnect();a.o&&(a.w+=(new Date-a.o)/1E3,delete a.o);a.H=!1});navigator.webkitGetUserMedia({audio:!0},function(a){sourceNode=p.createMediaStreamSource(a);q();$(".flyoutsDiv").load("csmSettings.html",function(){da.t(r,Z,L);ea.t(L)});r.Play()},Y)},Y);
