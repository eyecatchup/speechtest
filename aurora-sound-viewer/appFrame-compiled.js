function l(){this.H=!1;this.w=0}var m=new (window.AudioContext||window.webkitAudioContext);function q(a,b){var c=sourceNode,d=new l,e=new l;r(d,c,a);r(e,c,b);var f=m.createChannelSplitter(2);c.connect(f);f.connect(d.k,1,0);f.connect(e.k,0,0);c.connect(m.destination);l.prototype.Play=function(){d.c.connect(m.destination);e.c.connect(m.destination)};l.prototype.S=function(){d.c.disconnect();e.c.disconnect()}}
function r(a,b,c){a.ba=c;a.k=m.createAnalyser();a.k.smoothingTimeConstant=0.3;a.k.fftSize=2048;a.O=b;a.O.connect(a.k);s(a,512)}function s(a,b){a.c&&a.c.disconnect();a.c=m.createJavaScriptNode(b,1,1);a.c.onaudioprocess=function(){var b=a.ba,d=new Uint8Array(a.k.frequencyBinCount);a.k.getByteFrequencyData(d);a.O.playbackState==a.O.PLAYING_STATE&&b(d)};a.k.connect(a.c);a.H&&a.Play()}function t(){var a=u;return a.p?a.w+(new Date-a.p)/1E3:a.w}
l.prototype.Play=function(){this.c.connect(m.destination);this.H=!0;this.p||(this.p=new Date)};l.prototype.S=function(){this.c.disconnect();this.p&&(this.w+=(new Date-this.p)/1E3,delete this.p);this.H=!1};new chroma.ColorScale({colors:["#f00","#ff0","#0f0","#0ff","#00f"],mode:"rgb"});var v=new chroma.ColorScale({colors:"#f00 #f00 #ff0 #0f0 #0ff #00f #00f".split(" "),mode:"rgb"}),w=new chroma.ColorScale({colors:"#f08 #f00 #ff0 #0f0 #0ff #00f #80f".split(" "),mode:"rgb"});
function x(a,b,c){if(!c.a||c.a.length!=a.length){c.a=Array(parseInt(a.length));for(var d=0;d<c.a.length;d++)c.a[d]=0}for(d=0;d<c.a.length;d++)c.a[d]=a[d]<c.a[d]?c.a[d]+(a[d]-c.a[d])/5:c.a[d]+(a[d]-c.a[d])/200;for(d=0;d<a.length;d++){var e=a[d]-c.a[d]*b,e=256*e/(256-c.a[d]*b);a[d]=e}}
function y(a,b,c,d){for(var e=[],f=0;f<a.length;f++){var g=w.getColor(f/(a.length-1)).hsv();e.push({val:a[f],l:g[0]})}e.sort(function(a,b){return b.val-a.val});c.globalAlpha=1;c.globalCompositeOperation="source-over";c.fillStyle="#000";c.fillRect(0,0,1,b.height);a=0.5;for(var h=null,k=0,f=0;f<e.length;f++){var n=e[f];switch(d){case "HSL1":g=a;a+=1/e.length/2;c.fillStyle=chroma.hsl(n.l,1,g).hex();break;case "Opacity":c.fillStyle="hsla("+n.l+", 100%, 50%, 0.1)";break;case "HSV1":var p=1-f/e.length;
c.fillStyle=chroma.hsv(n.l,1,p).hex();break;case "HSV2":null==h&&(h=chroma.rgb(0,0,0));this_color=chroma.hsv(n.l,1,1);h=g=chroma.interpolate(h,this_color,1/(f+1),"rgb");c.fillStyle=g.hex();break;case "HSV3":p=n.val/256;null==h&&(h=chroma.rgb(0,0,0));this_color=chroma.hsv(n.l,1,p);h=g=chroma.interpolate(h,this_color,1/(f+1),"rgb");p/=e.length;g=g.hsv();g=chroma.hsv(g[0],g[1],k+p);k+=p;c.fillStyle=g.hex();break;case "HSV4":p=n.val/256,g=chroma.hsv(n.l,1,2.25*(p/e.length)),c.globalCompositeOperation=
"lighter",c.fillStyle=g.hex()}c.fillRect(0,(1-n.val/256)*b.height,1,b.height)}c.globalCompositeOperation="source-over"}function z(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push({val:a[e],l:v.getColor(e/(a.length-1)).hsv()[0]});d.sort(function(a,b){return b.val-a.val});c.globalAlpha=1;c.fillStyle="#000";c.fillRect(0,0,1,b.height);for(e=0;e<d.length;e++)a=d[e],this_color=chroma.hsv(a.l,1,a.val/256),c.fillStyle=this_color.hex(),c.fillRect(0,(1-a.val/256)*b.height,1,5)};function A(){this.d=[];this.C=[];B(this,"ColorDbl");this.v="HSV4";this.h=250;var a={h:300};a.mode&&B(this,a.mode);a.h&&(this.h=a.h);this.e=document.createElement("canvas");this.g=this.e.getContext("2d");this.e.width=1;this.i=document.createElement("canvas");this.D=this.i.getContext("2d");this.aa=document.createElement("canvas");this.aa.getContext("2d");this.hot=new chroma.ColorScale({colors:["#000000","#ffffff"],ca:[0,1],mode:"rgb",limits:[0,300]})}
function C(a,b){a.height!=b&&(a.height=b,console.log("set height "+b))}function B(a,b){a.mode=b;a.f=0;a.U=0;a.T=0;a.I=0;a.b=0.75;switch(b){case "SpectLog":a.o=150;a.n=12E3;break;case "LogStretch":a.o=150;a.n=12E3;a.f=13;break;case "HueValues":a.o=150;a.n=12E3;a.f=32;break;case "HueDots":a.o=150;a.n=12E3;a.f=7;break;case "ColorDbl":a.o=550,a.n=6E3,a.f=7,a.U=80,a.T=1100,a.I=100}}function D(a,b){E(b,a.o,a.n,a.f,a.d)}
function E(a,b,c,d,e){if(e.length!=d){for(e.splice(0,e.length);e.length<d;)e.push(0);console.log("LogBins: "+d+" ("+e.length+")")}logBinLength=e.length;Math.log(b);Math.log(c);var f,g,h,k;for(d=0;d<logBinLength;d++){f=Math.log(22050);g=Math.log(b)/f;h=Math.log(c)/f;k=g+d/logBinLength*(h-g);g+=(d+1)/logBinLength*(h-g);k=Math.pow(Math.E,k*f);g=Math.pow(Math.E,g*f);f=k*a.length/22050;k=g*a.length/22050;g=0;for(h=Math.floor(f);h<=Math.ceil(k);h++)g+=a[h];g/=Math.ceil(k)-Math.floor(f)+1;e[d]=g}}
function F(a){var b=G;C(b.e,b.h);switch(b.mode){case "FullLin":C(b.i,a.length);H(b,b.D,a);b.g.drawImage(b.i,0,0,1,a.length,0,0,1,b.h);break;case "SpectLog":b.f=b.h;D(b,a);0<b.b&&x(b.d,b.b,b.e);H(b,b.g,b.d);break;case "LogStretch":C(b.i,b.f);D(b,a);0<b.b&&x(b.d,b.b,b.e);0<b.b&&x(b.d,b.b,b.e);a=b.d.length;for(var c=chroma.rgb(0,0,0),d=0;d<a;d++){var e=w.getColor(d/(a-1));b.D.fillStyle=chroma.interpolate(c,e,b.d[d]/256,"rgb").hex();b.D.fillRect(0,a-1-d,1,1)}b.g.drawImage(b.i,0,0,1,b.f,0,0,1,b.h);break;
case "HueValues":D(b,a);0<b.b&&x(b.d,b.b,b.e);y(b.d,b.e,b.g,b.v);break;case "HueDots":D(b,a);z(b.d,b.e,b.g);break;case "ColorDbl":D(b,a);0<b.b&&x(b.d,b.b,b.e);b.g.globalAlpha=1;y(b.d,b.e,b.g,b.v);C(b.i,b.I);E(a,b.U,b.T,b.I,b.C);x(b.C,0.9,b.i);a=b.i;c=b.D;d=b.C;c.globalAlpha=1;c.clearRect(0,0,1,d.length);for(var f=e=0;f<d.length;f++)e+=d[f]/256;e/=d.length;d=(1-e)*a.height;c.fillStyle="#222";e=c.createLinearGradient(0,d,0,d+a.height);e.addColorStop(0,"#222");e.addColorStop(1,"#000");c.fillStyle=e;
c.fillRect(0,d,1,a.height);a=2*(b.h/3);c=1*(b.h/3);b.g.globalCompositeOperation="lighter";b.g.drawImage(b.i,0,0,1,b.C.length,0,a,1,c);b.g.globalCompositeOperation="source-over"}return b.e}function H(a,b,c){for(var d=c.length,e=0;e<d;e++)b.fillStyle=a.hot.getColor(c[e]).hex(),b.fillRect(0,d-1-e,1,1)};function I(){this.B=!1;this.R=1}function J(a,b){a.height!=b&&(a.height=b,console.log("set height "+b))}function K(a){var b=new I;b.t(a);return b}I.prototype.t=function(a){$canvas=$(a);this.canvas=$canvas[0];this.G=this.canvas.getContext("2d");L(this);this.V=32;this.L=2};
function L(a){var b=$(a.canvas),c=b.parent().height(),d=b.parent().width(),e=Math.round(b.parent().width()*a.R);if(a.canvas.width!=e||b.height()!=c){var f=document.createElement("canvas");f.width=a.canvas.width;f.height=a.canvas.height;f.getContext("2d").drawImage(canvas,0,0);a.canvas.width=e;a.G.drawImage(f,e-f.width,0);b.css("width",d+"px");b.css("height",c+"px");console.log("CanvasResize w:"+a.canvas.width+"->"+e+","+d+" h:"+a.canvas.height+"->"+c)}}
function M(a,b){var c=a.canvas.width,d=a.canvas.height;a.G.drawImage(a.canvas,-1*a.L,0,c,d);J(a.canvas,b.height);a.B&&!a.N?(L(a),a.N=setInterval(function(){L(a)},2E3)):!a.B&&a.N&&delete a.N;a.G.drawImage(b,c-a.V,0,a.V,d);a.M&&a.M(b)}function aa(a,b){for(var c=a.toDataURL("image/png"),c=atob(c.substring(22)),d=new Uint8Array(c.length),e=0,f=c.length;e<f;++e)d[e]=c.charCodeAt(e);b(new Blob([d.buffer],{type:"image/png"}))};function N(){if($(".jsHeightToBottom").length){var a=$(window).height()-$(".jsHeightToBottom").offset().top;$(".jsHeightToBottom").height(a-3)}}
function ba(){var a=$(".windowBtn_min"),b=$(".windowBtn_max"),c=$(".windowBtn_close");$(window).on("focus",function(){$("body").addClass("hasFocus")});$(window).on("blur",function(){$("body").removeClass("hasFocus")});if(chrome.app.window){var d=chrome.app.window.current();a.on("click",function(){d.minimize()});b.on("click",function(){d.isMaximized()?d.restore():d.maximize()});c.on("click",function(){d.close()})}setTimeout(N,50);$(window).on("resize",function(){N()})}
window.addEventListener("load",function(){ba()});function O(){}function P(a,b){void 0!=Q()[b]&&$("."+a).val(Q()[b]).change()}function R(a){var b=a.m,c=b.mode;""!=b.v&&(c+="/"+b.v);$(".csmAlg").val(c);$(".csmMoveByPx").val(a.canvas.L);$(".csmLog1Min").val(b.o);$(".csmLog1Max").val(b.n);$(".csmLogSteps").val(b.f);$(".csmDamper").val(b.b);$(".csmBufferSize").val(a.P.c?a.P.c.bufferSize:512);$(".csmXCompress").val(a.canvas.R)}
function ca(a){$(".csmAlg").on("change",function(){var b=$(".csmAlg").val().split("/"),c=2==b.length?b[1]:"";B(a.m,b[0]);a.m.v=c;R(a)});$(".csmMoveByPx").on("change",function(){a.canvas.L=$(".csmMoveByPx").val()});$(".csmLog1Min").on("change",function(){a.m.o=$(".csmLog1Min").val()});$(".csmLog1Max").on("change",function(){a.m.n=$(".csmLog1Max").val()});$(".csmLogSteps").on("change",function(){a.m.f=$(".csmLogSteps").val()});$(".csmDamper").on("change",function(){a.m.b=$(".csmDamper").val()});$(".csmBufferSize").on("change",
function(){s(a.P,$(".csmBufferSize").val())});$(".csmXCompress").on("change",function(){a.canvas.R=$(".csmXCompress").val()})}
O.prototype.t=function(a,b,c){$optionsLink=$(".settingsToggler");$optionsDiv=$(".settingsDiv");0==$optionsDiv.length&&console.log("Error: settings.Init() called before html loaded!");this.m=b;this.canvas=c;this.P=a;ca(this);R(this);P("csmAlg","alg");P("csmMoveByPx","moveByPx");P("csmLog1Min","log1Min");P("csmLog1Max","log1Max");P("csmLogSteps","logSteps");P("csmDamper","damper");P("csmBufferSize","bufferSize");P("csmXCompress","xCompress");$optionsLink.on("click",function(){$optionsDiv.slideToggle();
return!1});$(document).click(function(){$optionsDiv.slideUp()});$optionsDiv.click(function(a){a.stopPropagation()})};function da(){this.q=[];this.$=this.F=0}function ea(a,b){console.log("Recording start, elapsed: "+t());a.F=0;a.q=[];a.A=b;a.A.M=function(b){var d=a.F%1E3;a.F++;if(0==d){console.log("cnvsAr ++");var e=document.createElement("canvas");e.width=1E3;e.height=b.height;a.q.push(e)}a.q[a.q.length-1].getContext("2d").drawImage(b,d,0,1,b.height)};a.$=t()}function S(){this.q=[]}
S.prototype.t=function(a){var b=this;this.A=a;$(".csmPngStartBtn").on("click",function(){b.r=new da;ea(b.r,b.A);$(".csmPngStartBtn").hide();$(".csmPngDiv").slideDown()});$(".csmPngDiscardBtn").on("click",function(){var a=b.r;console.log("Recording stop,  elapsed: "+t());delete a.A.M;delete b.r;$(".csmPngDiv").slideUp();$(".csmPngStartBtn").show()});$(".csmPngSaveBtn").on("click",function(){fa(b)})};
function ga(a,b,c){var d=saveDlg.j;cnvsAr=a.q;lineCount=Math.ceil(d/c);a=document.createElement("canvas");a.width=Math.min(d,c);a.height=b*lineCount;for(var d=a.getContext("2d"),e=0;e<cnvsAr.length;e++)for(var f=1E3*e,g=Math.floor(f/c),f=f-g*c,g=g*b,h=Math.ceil((1E3-(c-f))/c),k=0;k<=h;k++)d.drawImage(cnvsAr[e],0,0,cnvsAr[e].width,cnvsAr[e].height,f-c*k,parseInt(g)+b*k,cnvsAr[e].width,b);return a}
function ha(a,b){var c="aurora_"+(saveDlg.u?saveDlg.u+"h":"")+saveDlg.J+"m"+saveDlg.W+"s.png";aa(a,function(a){chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:c},function(c){c?c.createWriter(function(c){c.onwriteend=function(){console.log("Save complete!");b()};c.write(a)},function(a){console.log(a)}):(console.log("No writableFileEntry."),b())})})}
function T(){var a=saveDlg,b=a.document,c=$(".jsLineHeight",b).val(),d=$(".jsWrapAt",b).val(),e=$(".jsWrapUnits",b).val(),f=999;"px"==e?f=Math.round(d):"sec"==e?f=Math.round(d/a.s*a.j):"min"==e?f=Math.round(60*(d/a.s)*a.j):"nths"==e&&(f=Math.ceil(a.j/d));$(".jsLineWidth",b).val(f);$(".jsLinePxEach",b).html(f);d=Math.ceil(100*(a.j/f))/100;e=Math.min(f,a.j);c*=Math.ceil(d);$(".jsLineCount",b).html(d);$(".jsFinalPngX",b).html(e);$(".jsFinalPngY",b).html(c);$(".jsLineTimeEach",b).html(Math.round(Math.min(f,
a.j)/a.j*a.s,1));32767<e||32767<c?$(".jsDimLimitWarning",b).slideDown():$(".jsDimLimitWarning",b).slideUp()}
function fa(a){chrome.app.window.create("appPngSave.html",{bounds:{width:500,height:400},frame:"none"},function(b){saveDlg=b.contentWindow;saveDlg.j=a.r.F;saveDlg.s=t()-a.r.$;saveDlg.u=Math.floor(saveDlg.s/60/60);saveDlg.J=Math.floor(saveDlg.s/60)-60*saveDlg.u;saveDlg.W=Math.floor(saveDlg.s)-3600*saveDlg.u-60*saveDlg.J;saveDlg.addEventListener("load",function(){var c=saveDlg.document;$(".jsTotalPx",c).html(saveDlg.j);$(".jsDuration",c).html(saveDlg.u+"h "+saveDlg.J+"m "+saveDlg.W+"s");T();$(".jsRefreshDimsOnInput",
c).on("input",function(){T()});$(".jsRefreshDimsOnChange",c).on("change",function(){T()});$(".jsSavePngNow",c).on("click",function(){var d=$(".jsLineHeight",c).val(),e=$(".jsLineWidth",c).val(),d=ga(a.r,d,e);ha(d,function(){b.close()})});$(".jsCancelPngNow",c).on("click",function(){b.close()})})})};function Q(){var a={};location.search.slice(1).split("&").forEach(function(b){b=b.split("=");a[b[0]]=b[1]||""});return a}function ia(a){a=F(a);M(U,a)}function V(){""==W.src+""&&(W.src=X,W.load(),sourceNode=m.createMediaElementSource(W),Y?q(function(a){var b=U;a=F(a);M(b,a)},function(a){var b=draw2;a=F(a);M(b,a)}):(sourceNode.connect(m.destination),r(u,sourceNode,ia)));u.Play();$(".filecontrols").hide();$(".controls1").css("visibility","visible")}
function Z(){$(".flyoutsDiv").load("csmSettings.html",function(){ja.t(u,G,U);ka.t(U)})}var W=new Audio;W.controls=!0;W.loop=!0;W.className="audio1";W.volume=1;W.style.verticalAlign="middle";var X=Q().file,Y="on"==Q().stereo?!0:!1,u=new l,G,U,ja=new O,ka=new S;
window.addEventListener("load",function(){G=new A;U=K("#canvas");U.B=!0;Y&&(draw2=K("#canvas2"),draw2.B=!0);$(".divAudio1")[0].appendChild(W);$(W).on("play",function(){V()});$(W).on("pause",function(){u.S()});void 0!=X&&(V(),W.play(),Z());$("#attach").change(function(){var a=this.files[0],b=new FileReader;b.onloadend=function(a){a.target.readyState==FileReader.DONE&&(X=a.target.result,$(".loading").hide(),$(".loaded").show(),V(),W.play(),Z())};$(".loading").show();b.readAsDataURL(a)})},function(a){console.log(a)});
